"use strict";angular.module("hdilApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","angular-loading-bar","rzModule","ui.checkbox","vs-repeat"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home"}).when("/explore",{templateUrl:"views/explore.html",controller:"ExploreCtrl",controllerAs:"explore"}).otherwise({redirectTo:"/home"})}]).config(["cfpLoadingBarProvider",function(a){a.includeSpinner=!1}]),angular.module("hdilApp").controller("HomeCtrl",["$scope",function(a){a.title="Human data interaction<br>in Lombardia",a.description="Lorem ipsum dolor sit amet, vim laudem accommodare te. Mea an constituto honestatis referrentur, eros philosophia vim ei. Qui in esse oportere, etiam postea quaestio te eos. Quo ut cibo ludus iracundia, ea iudico maiorum invenire eum. Vocent voluptatum at vel, et modus ignota commune has, dico splendide ut mel. In eripuit recusabo eum."}]),angular.module("hdilApp").controller("ExploreCtrl",["$scope","apiservice","cfservice","$filter","$timeout",function(a,b,c,d,e){a.collapseModel={odabes:!1,categorie:!0,tipologie:!0,datasets:!0,tempo:!0},a.filtersModel={categorie:{},tipologie:{},datasets:{}},a.dimensionModel="ctgry",a.odabesModel="aggregated",a.normModel=!1,a.searchDatasets="",a.showDatasetsList=!1,a.sliders={};var f=function(){var b=[a.sliders.dwnld.value,a.sliders.pgvws.value,a.sliders.rtng.value];c.upadateOdabes(b),c.typeSingle().filter("API"),c.typeSingle().filterAll()};a.sliders.dwnld={value:.5,options:{floor:0,ceil:1,precision:1,step:.1,onEnd:f}},a.sliders.pgvws={value:.5,options:{floor:0,ceil:1,precision:1,step:.1,onEnd:f}},a.sliders.rtng={value:.5,options:{floor:0,ceil:1,precision:1,step:.1,onEnd:f}},a.sliderTime={options:{translate:function(a){if(a){var b=d3.timeFormat("%B %Y");return b(a)}return""},noSwitching:!0}},a.refreshSlider=function(){e(function(){a.$broadcast("rzSliderForceRender")})},a.dataTable,a.dataTableHeaders,a.headerDict={odabes:"odabes",dwnld:"download",pgvws:"visualizzazioni",rtng:"voti",ctgry:"categoria",type:"tipologia",dts_id:"dataset"},a.tableItemsPerPage=100,a.tableCurrentPage=1,a.tableTotalItems=0,a.tablePagMaxSize=10,a.tableOffset=a.tableItemsPerPage*(a.tableCurrentPage-1);var g="4m2z-j67g.json";b.getDatasetInfo(g).then(function(b){var c=d3.timeFormat("%d/%m/%Y");a.lastModified=c(new Date(1e3*b.viewLastModified))},function(b){a.errors=b}),b.getRowsCount(g).then(function(d){var e=d[0].count;b.getDataset(g,e).then(function(b){var b=b.map(function(a){var b=a.dwnld?+a.dwnld:0,c=a.pgvws?+a.pgvws:0,d=a.rtng?+a.rtng:0;Math.round((b+c+d)/3);return{ctgry:a.ctgry,dts_id:a.dts_id,date:new Date(+a.anno_mese.split("/")[0],+a.anno_mese.split("/")[1]-1),tipo:a.tipo,nome:a.nome,lnk_data:a.lnk_data,dwnld:b,pgvws:c,rtng:d,anno_mese:a.anno_mese}});b=b.filter(function(a){return a.ctgry&&a.dts_id&&a.tipo}),a.dts_dict=d3.map(b,function(a){return a.dts_id}),c.add(b),a.dataTable=c.aggregated(a.dimensionModel),a.tableTotalItems=a.dataTable.length,a.dataTableHeaders=["title","odabes","viz","dwnld","pgvws","rtng"],a.categorie=c.ctgrysSingle().all(),a.categorie.forEach(function(b){a.filtersModel.categorie[b.key]=!0}),a.tipologie=c.typesSingle().all(),a.tipologie.forEach(function(b){a.filtersModel.tipologie[b.key]=!0}),a.datasets=c.dts_idsSingle().all(),a.datasets.forEach(function(b){a.filtersModel.datasets[b.key]=!0}),a.sliderTime.options.stepsArray=d3.timeMonth.range(c.date().bottom(1)[0].date,c.date().top(1)[0].date),a.sliderTime.minValue=a.sliderTime.options.stepsArray[0],a.sliderTime.maxValue=a.sliderTime.options.stepsArray[a.sliderTime.options.stepsArray.length-1],a.sliderTime.options.onChange=a.changeFilterTime,a.totalDatasets=c.dts_idsSingle().size()},function(b){a.errors=b})},function(b){a.errors=b}),a.changeFilterCtgry=function(){var b=d3.entries(a.filtersModel.categorie).filter(function(a){return a.value}).map(function(a){return a.key});c.ctgrySingle().filter(function(a){return b.indexOf(a)>-1})},a.changeFilterType=function(){var b=d3.entries(a.filtersModel.tipologie).filter(function(a){return a.value}).map(function(a){return a.key});c.typeSingle().filter(function(a){return b.indexOf(a)>-1})},a.changeFilterDatasets=function(){var b=d3.entries(a.filtersModel.datasets).filter(function(a){return a.value}).map(function(a){return a.key});c.dts_idSingle().filter(function(a){return b.indexOf(a)>-1})},a.changeFilterTime=function(a,b,d,e){c.date().filter(function(a){return a.getTime()>=b.getTime()&&a.getTime()<=d.getTime()})},a.filterSelectAll=function(b){for(var c in a.filtersModel[b])a.filtersModel[b][c]=!0;switch(b){case"categorie":a.changeFilterCtgry();break;case"tipologie":a.changeFilterType();break;case"datasets":a.changeFilterDatasets()}},a.filterDeSelectAll=function(b){for(var c in a.filtersModel[b])a.filtersModel[b][c]=!1;switch(b){case"categorie":a.changeFilterCtgry();break;case"tipologie":a.changeFilterType();break;case"datasets":a.changeFilterDatasets()}},a.pageChange=function(){a.tableOffset=a.tableItemsPerPage*(a.tableCurrentPage-1)};var h=function(a,b){var c=d("tableExclusion")(a).length;return c};a.$watch("dimensionModel",function(b,d){if(b!=d&&b){switch(a.odabesModel){case"aggregated":a.dataTable=c.aggregated(b);break;case"evolution":a.dataTable=c.evolution(b)}a.tableTotalItems=h(a.dataTable)}}),a.$watch("odabesModel",function(b,d){if(b!=d&&b){switch(b){case"aggregated":a.dataTable=c.aggregated(a.dimensionModel);break;case"evolution":a.dataTable=c.evolution(a.dimensionModel)}a.tableTotalItems=h(a.dataTable)}}),a.$watchGroup(["sliders.dwnld.value","sliders.pgvws.value","sliders.rtng.value"],function(a,b){}),c.cf().onChange(function(b){if(a.dataTable&&"filtered"==b){switch(a.odabesModel){case"aggregated":a.dataTable=c.aggregated(a.dimensionModel);break;case"evolution":a.dataTable=c.evolution(a.dimensionModel)}a.tableTotalItems=h(a.dataTable)}})}]),angular.module("hdilApp").factory("apiservice",["$http","$q",function(a,b){var c="https://www.dati.lombardia.it/resource/",d="https://www.dati.lombardia.it/views/",e="TBT9Tm1QSXZ4rGrsVGYYIbRrG";return{getRowsCount:function(d){var f={$$app_token:e,$query:"select count(*) as count"},g=c+d,h=b.defer();return a.get(g,{params:f}).then(function(a){h.resolve(a.data)},function(a){h.reject("An error occured while fetching url")}),h.promise},getDataset:function(d,f){var g={$$app_token:e,$limit:f},h=c+d,i=b.defer();return a.get(h,{params:g}).then(function(a){i.resolve(a.data)},function(a){i.reject("An error occured while fetching url")}),i.promise},getDatasetInfo:function(c){var f={$$app_token:e},g=d+c,h=b.defer();return a.get(g,{params:f}).then(function(a){h.resolve(a.data)},function(a){h.reject("An error occured while fetching url")}),h.promise}}}]),angular.module("hdilApp").factory("cfservice",function(){function a(a,b){return b.dts_id in a.datasets?a.datasets[b.dts_id]+=1:(a.datasets[b.dts_id]=1,a.count++),a}function b(a,b){return a.datasets[b.dts_id]--,0===a.datasets[b.dts_id]&&(delete a.datasets[b.dts_id],a.count--),a}function c(){return{count:0,datasets:{}}}function d(a,b){return b.dts_id in a.datasets?a.datasets[b.dts_id]+=1:(a.datasets[b.dts_id]=1,a.count++),a.dwnld+=b.dwnld,a.pgvws+=b.pgvws,a.rtng+=b.rtng,a.odabes=h(a.dwnld,a.pgvws,a.rtng),a}function e(a,b){return a.datasets[b.dts_id]--,0===a.datasets[b.dts_id]&&(delete a.datasets[b.dts_id],a.count--),a.dwnld-=b.dwnld,a.pgvws-=b.pgvws,a.rtng-=b.rtng,a.odabes=h(a.dwnld,a.pgvws,a.rtng),a}function f(){return{count:0,odabes:0,dwnld:0,pgvws:0,rtng:0,datasets:{}}}function g(a){return a.odabes}function h(a,b,c){return(a*D+b*E+c*F)/3}var i=crossfilter([]),j=i.dimension(function(a){return a.ctgry}),k=j.group().reduce(d,e,f).order(g),l=i.dimension(function(a){return a.ctgry}),m=l.group().reduce(a,b,c),n=i.dimension(function(a){return a.tipo}),o=n.group().reduce(d,e,f).order(g),p=i.dimension(function(a){return a.tipo}),q=p.group().reduce(a,b,c),r=i.dimension(function(a){return a.date}),s=r.group(d3.timeMonth).reduce(d,e,f).order(g),t=i.dimension(function(a){return a.dts_id}),u=t.group().reduce(d,e,f).order(g),v=i.dimension(function(a){return a.dts_id}),w=v.group().reduce(a,b,c),x=i.dimension(function(a){return a.anno_mese+" - "+a.ctgry}),y=x.group().reduce(d,e,f).order(g),z=i.dimension(function(a){return a.anno_mese+" - "+a.tipo}),A=z.group().reduce(d,e,f).order(g),B=i.dimension(function(a){return a.anno_mese+" - "+a.dts_id}),C=B.group().reduce(d,e,f).order(g),D=.5,E=.5,F=.5,G={};return G.add=function(a){i.add(a)},G.clear=function(){i.remove()},G.size=function(){return i.size()},G.date=function(){return r},G.dates=function(){return s},G.ctgry=function(){return j},G.ctgrys=function(){return k},G.ctgrySingle=function(){return l},G.ctgrysSingle=function(){return m},G.type=function(){return n},G.types=function(){return o},G.typeSingle=function(){return p},G.typesSingle=function(){return q},G.dts_id=function(){return t},G.dts_ids=function(){return u},G.dts_idSingle=function(){return v},G.dts_idsSingle=function(){return w},G.date_ctgry=function(){return x},G.date_ctgrys=function(){return y},G.date_type=function(){return z},G.date_types=function(){return A},G.date_dts_id=function(){return B},G.date_dts_ids=function(){return C},G.cf=function(){return i},G.evolution=function(a){var b;switch(a){case"ctgry":b=y.all();break;case"type":b=A.all();break;case"dts_id":b=C.all()}var c=d3.extent(s.all(),function(a){return a.key}),d=d3.max(b,function(a){return a.value.odabes}),e=d3.nest().key(function(a){return a.key.split(" - ")[1]}).entries(b),f=e.map(function(a){var b=d3.map();return a.values.forEach(function(a){d3.keys(a.value.datasets).forEach(function(a){b.set(a,a)})}),a.title=a.key,delete a.key,a.evolution=a.values.map(function(a){var b={},c=d3.timeParse("%Y/%m");return b.date=c(a.key.split(" - ")[0]),b.value=a.value.odabes,b}),a.odabes=d3.sum(a.values,function(a){return a.value.odabes}),a.dwnld=d3.sum(a.values,function(a){return a.value.dwnld}),a.rtng=d3.sum(a.values,function(a){return a.value.rtng}),a.pgvws=d3.sum(a.values,function(a){return a.value.pgvws}),a.count=b.size(),a.extent=c,a.maxOdabesMonth=d,delete a.values,a});return f},G.aggregated=function(a){var b;switch(a){case"ctgry":b=k.all();break;case"type":b=o.all();break;case"dts_id":b=u.all()}var c=d3.scaleLinear().rangeRound([1,100]).domain([0,d3.max(b,function(a){return a.value.odabes})]),d=b.map(function(a){var b=a.value;return b.title=a.key,b.odabesPercentage=c(a.value.odabes),b});return d},G.upadateOdabes=function(a){D=a[0],E=a[1],F=a[2]},G}),angular.module("hdilApp").filter("tableExclusion",function(){return function(a){if(a&&a.length){var b=a.filter(function(a){return 0==a.odabes&&0==a.dwnld&&0==a.pgvws&&0==a.rtng?!1:!0});return b}}}),angular.module("hdilApp").filter("filterDatasetsExclusion",function(){return function(a,b,c){if(a){if(b)var d=a.filter(function(a){var d=c.get(a.key).nome.toLowerCase();return-1!==d.toLowerCase().indexOf(b)});else d=a;return d}}}),angular.module("hdilApp").filter("tablenumber",["$filter",function(a){return function(b){return angular.isNumber(b)?a("number")(Math.ceil(b),0):b}}]),angular.module("hdilApp").directive("timeline",["$timeout",function(a){return{restrict:"A",replace:!1,scope:{data:"=",extent:"=",maxy:"=",normalize:"="},link:function(b,c,d){var e,f,g,h=d3.select(c[0]);a(function(){e=parseInt(h.style("width").replace("px","")),f=20,g=hdil.timeline().width(e).height(f).extent(b.extent).maxY(b.maxy),h.datum(b.data).call(g)},0,!1),b.$watch("data",function(c,d){c!=d&&c&&a(function(){h.datum(c).call(g.maxY(b.maxy))},0,!1)},!0),b.$watch("normalize",function(b,c){b!=c&&b?a(function(){h.call(g.normalize(b))},0,!1):b==c||b||a(function(){h.call(g.normalize(b))},0,!1)})}}}]),angular.module("hdilApp").directive("evolutionaxis",["$timeout",function(a){return{restrict:"A",replace:!1,link:function(b,c,d){var e,f,g,h,i=d3.select(c[0]);a(function(){e=parseInt(i.style("width").replace("px","")),f=15;var a={top:0,right:0,bottom:0,left:0},c=e-a.left-a.right,d=f-a.top-a.bottom;g=i.append("svg").attr("width",e).attr("height",f).append("g").attr("transform","translate("+a.left+","+a.top+")"),h=d3.scaleTime().rangeRound([0,c]),h.domain(d3.extent(b.sliderTime.options.stepsArray)),g.append("g").attr("class","xAxis").attr("transform","translate(0,"+d+")").call(d3.axisTop(h).tickSize(0).tickPadding(0))},0,!1),b.$watch("scope.sliderTime.options.stepsArray",function(c,d){c!=d&&c&&a(function(){h.domain(d3.extent(b.sliderTime.options.stepsArray)),g.select("xAxis").call(d3.axisTop(h).tickSize(0).tickPadding(0))},0,!1)})}}}]),angular.module("hdilApp").run(["$templateCache",function(a){a.put("views/explore.html",'<div class="container-fluid explore-container"> <div class="row"> <div class="col-md-3 filter-container"> <div class="statsInfo"> <p> Datasets: {{totalDatasets | number}} </p> <p> Ultimo aggiornamento: {{lastModified}} </p> </div> <div class="filter-dimension-container"> <div class="accordion" ng-click="collapseModel.odabes = !collapseModel.odabes">configurazione odabes <i class="material-icons">add</i></div> <div uib-collapse="collapseModel.odabes" expanding="refreshSlider()"> <div class="slider-container"> <h5>download</h5> <rzslider rz-slider-model="sliders.dwnld.value" rz-slider-options="sliders.dwnld.options"></rzslider> </div> <div class="slider-container"> <h5>visualizzazioni</h5> <rzslider rz-slider-model="sliders.pgvws.value" rz-slider-options="sliders.pgvws.options"></rzslider> </div> <div class="slider-container"> <h5>voti</h5> <rzslider rz-slider-model="sliders.rtng.value" rz-slider-options="sliders.rtng.options"></rzslider> </div> </div> </div> <div class="filter-dimension-container"> <div class="accordion" ng-click="collapseModel.categorie = !collapseModel.categorie">categorie<i class="material-icons">add</i></div> <div uib-collapse="collapseModel.categorie"> <div class="filter-controls"> <span ng-click="filterSelectAll(\'categorie\')">select all</span> / <span ng-click="filterDeSelectAll(\'categorie\')">deselect all</span> </div> <div class="filter-wrapper"> <div class="filter-checkbox-wrapper" ng-repeat="categoria in categorie"> <checkbox ng-model="filtersModel.categorie[categoria.key]" ng-change="changeFilterCtgry()"></checkbox> {{categoria.key}} ({{categoria.value.count}}) </div> </div> </div> </div> <div class="filter-dimension-container"> <div class="accordion" ng-click="collapseModel.tipologie = !collapseModel.tipologie">tipologie<i class="material-icons">add</i></div> <div uib-collapse="collapseModel.tipologie"> <div class="filter-controls"> <span ng-click="filterSelectAll(\'tipologie\')">select all</span> / <span ng-click="filterDeSelectAll(\'tipologie\')">deselect all</span> </div> <div class="filter-wrapper"> <div class="filter-checkbox-wrapper" ng-repeat="tipologia in tipologie"> <checkbox ng-model="filtersModel.tipologie[tipologia.key]" ng-change="changeFilterType()"></checkbox> {{tipologia.key}} ({{tipologia.value.count}}) </div> </div> </div> </div> <div class="filter-dimension-container"> <div class="accordion" ng-click="collapseModel.datasets = !collapseModel.datasets">datasets<i class="material-icons">add</i></div> <div uib-collapse="collapseModel.datasets" expanded="showDatasetsList = true" collapsing="showDatasetsList = false"> <div class="form-group"> <input class="form-control" placeholder="Cerca" ng-model="searchDatasets" ng-minlength="3" ng-model-options="{ debounce: 500 }"> </div> <div class="filter-controls"> <span ng-click="filterSelectAll(\'datasets\')">select all</span> / <span ng-click="filterDeSelectAll(\'datasets\')">deselect all</span> </div> <div class="filter-wrapper" ng-init="filteredDts = {}"> <div class="filter-dts-loading" ng-if="!showDatasetsList"> loading... </div> <div vs-repeat ng-if="showDatasetsList"> <div class="filter-checkbox-wrapper" ng-repeat="dataset in filteredDts.result = ( datasets | filterDatasetsExclusion:searchDatasets:dts_dict )"> <checkbox ng-model="filtersModel.datasets[dataset.key]" ng-change="changeFilterDatasets()"></checkbox> {{dts_dict.get(dataset.key).nome}} </div> </div> </div> </div> </div> <div class="filter-dimension-container filter-tempo"> <div class="accordion" ng-click="collapseModel.tempo = !collapseModel.tempo">tempo<i class="material-icons">add</i></div> <div uib-collapse="collapseModel.tempo" expanding="refreshSlider()"> <rzslider rz-slider-model="sliderTime.minValue" rz-slider-high="sliderTime.maxValue" rz-slider-options="sliderTime.options"></rzslider> </div> </div> </div> <div class="col-md-9 viz-container"> <div class="row table-controller"> <div class="col-md-5"> <h6>Mostra</h6> <div class="btn-group"> <label class="btn btn-primary" ng-model="dimensionModel" uib-btn-radio="\'ctgry\'">Categorie</label> <label class="btn btn-primary" ng-model="dimensionModel" uib-btn-radio="\'type\'">Tipologie</label> <label class="btn btn-primary" ng-model="dimensionModel" uib-btn-radio="\'dts_id\'">Dataset</label> </div> </div> <div class="col-md-4"> <h6>Mostra odabes</h6> <div class="btn-group"> <label class="btn btn-primary" ng-model="odabesModel" uib-btn-radio="\'aggregated\'">aggregato</label> <label class="btn btn-primary" ng-model="odabesModel" uib-btn-radio="\'evolution\'">evoluzione</label> </div> </div> <div class="col-md-2 normalizza" ng-show="odabesModel==\'evolution\'"> <checkbox ng-model="normModel"></checkbox> stessa scala </div> </div> <div class="row table-container"> <div class="col-md-12 flex"> <table class="table" id="mainTable"> <thead> <tr> <th ng-repeat="head in dataTableHeaders" ng-class="{fitCell: head == \'odabes\',vizCell: head == \'viz\', titleCell:  head == \'title\' }"> <span ng-if="head == \'title\'">{{headerDict[dimensionModel]}}</span> <div ng-if="head == \'viz\' && odabesModel == \'evolution\'" evolutionaxis> </div> <span ng-if="head != \'viz\' && head != \'title\'">{{headerDict[head]}}</span> </th> </tr> </thead> <tbody> <tr ng-repeat="row in dataTable | tableExclusion | orderBy:\'odabes\':true | limitTo:tableItemsPerPage:tableOffset track by row.title"> <td ng-repeat="head in dataTableHeaders" ng-class="{fitCell: head == \'odabes\', vizCell: head == \'viz\', titleCell:  head == \'title\'}"> <span ng-if="head != \'viz\' && dimensionModel != \'dts_id\'">{{row[head] | tablenumber}}<span ng-if="head == \'title\'" class="rowInfo"><br>{{row.count}} datasets</span></span> <span ng-if="head == \'title\' && dimensionModel == \'dts_id\'"> <a ng-href="{{dts_dict.get(row[head]).lnk_data}}" target="_blank">{{dts_dict.get(row[head]).nome }}</a> <br> <span class="rowInfo">{{dts_dict.get(row[head]).ctgry}} - {{dts_dict.get(row[head]).tipo}}</span> </span> <span ng-if="head != \'title\' && dimensionModel == \'dts_id\'">{{row[head] | tablenumber}}</span> <span ng-if="head == \'viz\' && odabesModel==\'aggregated\'" ng-style="{width: row[\'odabesPercentage\']+\'%\'}" class="odabes-bar"></span> <div ng-if="head == \'viz\' && odabesModel==\'evolution\'" class="odabes-timeline" data="row.evolution" extent="row.extent" maxy="row.maxOdabesMonth" normalize="normModel" timeline></div> </td> </tr> </tbody> </table> </div> </div> <div class="row table-pagination"> <div class="col-md-12"> <ul ng-class="{notPaginated: tableTotalItems <= tableItemsPerPage}" uib-pagination boundary-links="true" force-ellipses="true" total-items="tableTotalItems" max-size="tablePagMaxSize" items-per-page="tableItemsPerPage" ng-model="tableCurrentPage" ng-change="pageChange()" class="pagination-sm" previous-text="&lsaquo;" next-text="&rsaquo;" first-text="&laquo;" last-text="&raquo;"></ul> </div> </div> </div> </div> </div>'),a.put("views/home.html",'<div class="container-wrapper"> <div class="container home-container"> <div class="row"> <div class="col-md-8"> <h1 ng-bind-html="title"></h1> <p> {{description}} </p> <a href="#!/explore" class="btn btn-default btn-lg btn-explore"> esplora i dati </a> </div> </div> </div> </div>')}]);